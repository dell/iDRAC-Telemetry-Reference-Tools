<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous" />
    <script src="http://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha384-vk5WoKIaW/vJyUAd9n/wmopsmNhiy+L2Z+SBxGYnUkunIxVxAv/UtMOhba/xskxh"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
</head>

<body>
    <nav class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0">
        <a class="navbar-brand col-sm-3 col-md-2 mr-0" href="#">Redfish Telemetry Service Configuration </a>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <nav class="col-md-2 d-none d-md-block bg-light sidebar">
                <div class="sidebar-sticky">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="#Servers">
                                <i data-feather="server"></i> Source Services
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <main role="main" class="col-md-9 ml-sm-auto col-lg-10 pt-3 px-4">
                <div class="chartjs-size-monitor"
                    style="position: absolute; left: 0px; top: 0px; right: 0px; bottom: 0px; overflow: hidden; pointer-events: none; visibility: hidden; z-index: -1;">
                    <div class="chartjs-size-monitor-expand"
                        style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;pointer-events:none;visibility:hidden;z-index:-1;">
                        <div style="position:absolute;width:1000000px;height:1000000px;left:0;top:0"></div>
                    </div>
                    <div class="chartjs-size-monitor-shrink"
                        style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;pointer-events:none;visibility:hidden;z-index:-1;">
                        <div style="position:absolute;width:200%;height:200%;left:0; top:0"></div>
                    </div>
                </div>
                <div
                    class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
                    <h1 class="h2">Dashboard</h1>
                </div>

                <h2><a id="Servers"></a>Redfish Telemetry Source Services</h2>
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>IP/Hostname</th>
                                <th>Username</th>
                                <th>State</th>
                                <th>Last Event</th>
                            </tr>
                        </thead>
                        <tbody id="services">
                        </tbody>
                    </table>
                </div>
                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#serviceModal">Add New
                    Service</button>
                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#csvModal">Upload CSV
                    File</button>
                <button type="button" class="btn btn-primary" id="deleteButton" style="display: none;"
                    onclick="deleteService(this)">Delete Service</button>
                <br>
                <br>
                <br>
                <h2><a id="HEC"></a>Splunk HTTP Event Collector</h2>
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>URL</th>
                                <th>Token</th>
                                <th>Index</th>
                            </tr>
                        </thead>
                        <tbody id="hec">
                        </tbody>
                    </table>
                </div>
                <button type="button" class="btn btn-primary" data-toggle="modal"
                    data-target="#hecModal">Config</button>
           
    <br>
    <br>
    <br>
    <h2><a id="Kafka"></a>Kafka Broker Configuration</h2>
    <div class="table-responsive">
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th>Broker</th>
                    <th>Topic</th>
                    <th>TLS</th>
                    <th>SkipHostnameVerify</th>
                    <th>ClientAuth</th>
                </tr>
            </thead>
            <tbody id="kafka">
            </tbody>
        </table>
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#kafkaModal">Config</button>
    </div>
    </main>
    </div>
    </div>

    <div class="modal fade" id="serviceModal" tabindex="-1" role="dialog" aria-labelledby="serviceModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Add New Service</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="newService">
                        <input class="form-control" id="hostname" name="hostname" type="text"
                            placeholder="Service IP/Hostname" />
                        <input class="form-control" id="username" name="username" type="text" placeholder="Username" />
                        <input class="form-control" id="password" name="password" type="password"
                            placeholder="Password" />
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="addService()">Add Service</button>
                </div>
            </div>
        </div>
    </div>
</main>
</div>
</div>
    <!--Code for handling the "Upload CSV File" modal dialog box-->
    <div class="modal fade" id="csvModal" tabindex="-1" role="dialog" aria-labelledby="csvModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadCsvModalLabel">Upload an CSV File</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form method='post' action='' enctype="multipart/form-data">
                        Select file : <input type='file' name='file' id='fileupload' class='form-control'><br>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="uploadFile()">Upload</button>
                </div>
            </div>
        </div>
    </div>
    <br>
    <br>
    <div class="modal fade" id="hecModal" tabindex="-1" role="dialog" aria-labelledby="hecModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Add Splunk HEC </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="newHEC">
                        <input class="form-control" id="url" name="url" type="text"
                            placeholder="http://splunkhost:8088" />
                        <input class="form-control" id="key" name="key" type="text" placeholder="HEC Token" />
                        <input class="form-control" id="index" name="index" type="text" placeholder="HEC Index Name" />
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="configHEC()">Config HEC</button>
                </div>
            </div>
        </div>
    </div>
    <br>
    <br>
    <div class="modal fade" id="kafkaModal" tabindex="-1" role="dialog" aria-labelledby="kafkaModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Kafka Broker configuration</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="newKafka" method='post' action='' enctype="multipart/form-data">
                        <input class="form-control" id="Broker" name="broker" type="text" placeholder="Broker ID" />
                        <input class="form-control" id="Topic" name="topic" type="text" placeholder="Topic name" /><br>
                        &nbsp;&nbsp;&nbsp;<label for="tls">
                            <input type="checkbox" id="tls" name="tls"> TLS
                        </label> &nbsp;&nbsp;&nbsp;
                        <label for="clientAuth">
                            <input type="checkbox" id="clientAuth" name="clientAuth"> Client Auth
                        </label><br>
                        <div id="column1" style="display: none;">
                            <label for="fileupload1">Kafka CACert:</label>
                            <input type='file' name='kafkaCACert' id='fileupload1' class='form-control'><br>
                            <label for="kafkaskipverify">
                                Skip Hostname Verification&nbsp;&nbsp;<input type="checkbox" id="kafkaskipverify"
                                    name="kafkaSkipVerify">
                            </label>
                        </div>
                        <div id="column2" style="display: none;">
                            <label for="fileupload2">Kafka Client Certificate</label>
                            <input type='file' name='kafkaClientCert' id='fileupload2' class='form-control'><br>
                            <label for="fileupload3">Kafka Client Key</label>
                            <input type='file' name='kafkaClientKey' id='fileupload3' class='form-control'><br>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="kafkaConfig()">Config Kafka</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Preview-->
    <div id='preview'></div>

    <!-- Bootstrap core JavaScript
================================================== -->

    <!-- Icons -->
    <script src="https://unpkg.com/feather-icons/dist/feather.min.js"></script>
    <script>
        feather.replace()
    </script>

    <script>
        
        const tls = document.getElementById('tls');
        const clientAuth = document.getElementById('clientAuth');
        const column1 = document.getElementById('column1');
        const column2 = document.getElementById('column2');

        tls.addEventListener('change', function () {
            if (tls.checked) {
                column1.style.display = 'block';
            } else {
                column1.style.display = 'none';
            }
        });
         
        clientAuth.addEventListener('change', function () {
            if (clientAuth.checked) {
                column2.style.display = 'block';
            } else {
                column2.style.display = 'none';
            }
        });

        function updateColumnsDisplay() {
            if (tls.checked && clientAuth.checked) {
                column1.style.display = 'block';
                column2.style.display = 'block';
            }
        }
        // Event listener for modal open
        let serviceData;
        $.getJSON("/api/v1/Systems", gotServiceList);
        $.getJSON("/api/v1/HttpEventCollector", gotConfigList);
        $.getJSON("/api/v1/KafkaBrokerConnection", gotKafkaConfigList);

        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })

        
        function gotServiceList(data) {
            var tbody = $('#services');
            serviceData = data;
            for (var i = 0; i < data.length; i++) {
                classStr = "text-warning"
                switch (data[i].State) {
                    case 'Running':
                        classStr = "text-success";
                        break;
                    case 'Stopped':
                        classStr = "text-danger";
                        break;
                }
                tbody.append('<tr><td>' + data[i].Hostname + '</td><td>' + data[i].Username + '</td><td class="' + classStr + '">' + data[i].State + '</td><td>' + new Date(data[i].LastEvent) + "</td><td><input type='checkbox' id='checkboxservice-" + i + "'' class='check' onclick='checkboxClick(this);' ></td></tr>")
            }
        }

        function gotConfigList(data) {
            var tbody = $('#hec');
            tbody.append('<tr><td>' + data.url + '</td><td>' + data.key + '</td><td>' + data.index + '</td></tr>')
        }

        function gotKafkaConfigList(data) {
            var tbody = $('#kafka');
            tbody.append('<tr><td>' + data.kafkaBroker + '</td><td>' + data.kafkaTopic + '</td><td>' + data.tls + '</td><td>' + data.kafkaSkipVerify + '</td><td>'  +  data.clientAuth + '</td></tr>' )
        }

        function checkboxClick(checkbox) {
            let checkboxIndex = parseInt(checkbox.id.split('-')[1])
            if (checkbox.checked) {
                serviceData[checkboxIndex].toDelete = true
            }
            else {
                serviceData[checkboxIndex].toDelete = false
            }
            if ($(".check:checked").length) $("#deleteButton").show();
            else $("#deleteButton").hide();
        };
        
        function readFileContents(file, callback) {
        const reader = new FileReader();
         reader.onload = function (event) {
             const contents = event.target.result;
             callback(contents);
         };
         reader.readAsText(file);         
}
        function isValidIP(ip) {
            // Boolean function to check whether argument is a valid IP using regex
            matches = ip.match('^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$')
            if (matches == null) {
                console.log("IP not valid")
                return false
            } else {
                console.log("IP valid")
                return true
            }
        }

        async function uploadFile() {
            let formData = new FormData();
            csvFile = fileupload.files[0];
            var isValidIPFlag = null;
            var isValidfieldsFlag = null;
            var isValidCSVFlag = null;
            if (csvFile) {

                // Check the format of the uploaded CSV file. 3 values in each line
                // and  first value should be a valid IP
                var reader = new FileReader();
                reader.readAsText(csvFile, "UTF-8");
                reader.onload = function (e) {
                    var rows = e.target.result.split("\n");
                    for (var i = 0; i < rows.length; i++) {
                        console.log('row', i)
                        var cells = rows[i].split(",");
                        if (cells.length == 3) {
                            //  Check if each row in the CSV file has 3 values
                            if (!isValidIP(cells[0])) {
                                // condition to check whether the IP is correct format
                                isValidIPFlag = false;
                            }
                        } else {
                            console.log("Row ", i, " should have 3 values")
                            isValidfieldsFlag = false;
                        }
                    }
                    // Uploaded file is invalid if either of the 2 conditions mentioned
                    // above (3 values in each line and  first value should be a valid IP)
                    // are not satisfied
                    if (isValidIP == false || isValidfieldsFlag == false) {
                        isValidCSVFlag = false
                    } else {
                        isValidCSVFlag = true
                    }

                    // Send POST request if uploaded file is valid
                    if (isValidCSVFlag == true) {
                        console.log("isValidCSV if ", isValidCSVFlag)
                        formData.append("file", fileupload.files[0]);
                        //  Send POST request with csv file as body 
                        fetch('/api/v1/CsvUpload', {
                            method: "POST",
                            body: formData,
                            contentType: 'text/csv'
                        }).then((uploadResponse) => {
                            if (!uploadResponse.ok) {
                                throw new Error(uploadResponse.statusText)
                            } else {
                                alert("CSV file processing completed. Refresh the page to confirm the services were added. "
                                    + "Check logs for results.")
                                $('#csvModal').modal('toggle');
                            }
                        }).catch((error) => {
                            alert("A runtime error has occured.")
                        });
                    } else if (isValidCSVFlag == false) {
                        // Alert the user if the uploaded file doesn't have the correct format
                        console.log("isValidCSV else ", isValidCSVFlag)
                        alert("Invalid CSV file format. Please ensure that the first value in every row "
                            + "is a valid IP and that there are 3 values in each row of the csv file (IP, username, password)")
                    }
                }
            }
        }



        function addService() {
            var arr = $('#newService').serializeArray();
            var obj = {};
            for (var i = 0; i < arr.length; i++) {
                obj[arr[i].name] = arr[i].value;
            }
            $.ajax({
                url: '/api/v1/Systems',
                method: 'POST',
                data: JSON.stringify(obj),
                contentType: 'application/json',
                dataType: 'json',
                complete: addDone
            })
        }
        function deleteService() {
            hostnames = []
            h = 0
            for (var i = 0; i < serviceData.length; i++) {
                if (serviceData[i].toDelete == true) {
                    hostnames[h++] = serviceData[i].Hostname
                }
            }
            $.ajax({
                url: '/api/v1/Delete',
                method: 'POST',
                data: JSON.stringify({ Hostname: hostnames }),
                contentType: 'application/json',
                dataType: 'json',
                complete: deleteDone
            })
        }

        function configHEC() {
            var arr = $('#newHEC').serializeArray();
            var obj = {};
            for (var i = 0; i < arr.length; i++) {
                obj[arr[i].name] = arr[i].value;
            }
            $.ajax({
                url: '/api/v1/HecConfig',
                method: 'POST',
                data: JSON.stringify(obj),
                contentType: 'application/json',
                dataType: 'json',
                complete: addhec
            })
        }

        // Getting the data from kafka model form and post an ajax request
        function kafkaConfig() {
            var form = document.getElementById('newKafka');
            var formData = new FormData(form);

            formData.forEach(function (value, key) {
                console.log(key, value);

                // For file inputs
                if (key.startsWith("file")) {
                    console.log(key, value.name); // Logs the name of the uploaded file
                }
            });


            var obj = {
                kafkaBroker: $("#Broker").val(),
                kafkaTopic: $("#Topic").val()
            };

            if ($("#tls").is(":checked")) {   
                    obj.tls="true";
                    obj.kafkaSkipVerify = $("#kafkaskipverify").is(":checked") ? "true" : "false";
                    const file1 = $('#fileupload1')[0].files[0];
                    if (file1) {
                        console.log("file1 ", file1);
                        readFileContents(file1, function (contents) {
                            obj.kafkaCACert = contents
                        });
                        console.log("kafkaCACert File:", file1.name);
                    }
                }

            

                if ($("#clientAuth").is(":checked")) {   
                    obj.clientAuth ="true";
                    const file2 = $('#fileupload2')[0].files[0];
                    if (file2) {
                        readFileContents(file2, function (contents) {
                            obj.kafkaClientCert = contents
                        });
                        console.log("kafkaClientCert File:", file2.name);
                    }
                    const file3 = $('#fileupload3')[0].files[0];
                    if (file3) {
                        readFileContents(file3, function (contents) {
                            obj.kafkaClientKey = contents
                        });
                        console.log("kafkaClientKey File:", file3.name);
                    }
                    }
         
            // sleep 3s
            (async () => {
                if (tls) {
                    await new Promise(done => setTimeout(() => done(), 3000));
                }

                //Send the AJAX request
                console.log("printing full object", JSON.stringify(obj))
                console.log(JSON.stringify("POST REQUEST DATA" + new FormData($("#newKafka")[0])));

                $.ajax({
                    url: '/api/v1/KafkaConfig',
                    method: 'POST',
                    data: JSON.stringify(obj),
                    contentType: 'application/json',
                    dataType: 'json',
                    complete: kafkaDone
                });
            
            })();
        }
        function addDone(jqXHR) {
            if (jqXHR.status != 200) {
                alert("Failed to add new service!");
            }
            else {
                location.reload();
            }
        }

        function addhec(jqXHR) {
            if (jqXHR.status != 200) {
                alert("Failed to config hec!");
            }
            else {
                location.reload();
            }
        }
        function deleteDone(jqXHR) {
            if (jqXHR.status != 200) {
                alert("Failed to delete new service!");
            }
            else {
                location.reload();
            }
        }

        function kafkaDone(jqXHR) {
            if (jqXHR.status != 200) {
                alert("Failed to add kafka config!");
            }
            else {
                location.reload();
                form=document.getElementById('newKafka');
                form.reset();
            }
        }

    </script>
</body>

</html>